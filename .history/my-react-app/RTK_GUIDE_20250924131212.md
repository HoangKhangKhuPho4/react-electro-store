# Redux Toolkit (RTK) và RTK Query Guide

## Giới thiệu

Redux Toolkit là cách chính thức và được khuyên dùng để sử dụng Redux. Nó bao gồm:
- **Redux Toolkit (RTK)**: Công cụ để quản lý state một cách đơn giản hơn
- **RTK Query**: Công cụ mạnh mẽ để fetch và cache data từ API

## Cài đặt

```bash
npm install @reduxjs/toolkit react-redux
```

## Cấu trúc thư mục

```
src/
  redux/
    store.js        # Cấu hình Redux store
    apiSlice.js     # RTK Query API slice
    appSlice.js     # Regular Redux slice cho state cục bộ
  components/
    RTKQueryDemo.jsx    # Demo RTK Query
    AppSliceDemo.jsx    # Demo Redux Slice
```

## 1. Redux Store (store.js)

```javascript
import { configureStore } from '@reduxjs/toolkit'
import { setupListeners } from '@reduxjs/toolkit/query'
import { apiSlice } from './apiSlice'
import appReducer from './appSlice'

export const store = configureStore({
  reducer: {
    api: apiSlice.reducer,
    app: appReducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware().concat(apiSlice.middleware),
})

setupListeners(store.dispatch)
```

## 2. RTK Query (apiSlice.js)

RTK Query giúp bạn:
- Fetch data từ API một cách tự động
- Cache kết quả để tăng performance
- Quản lý loading và error states
- Invalidate cache khi cần thiết

### Ưu điểm của RTK Query:
- **Tự động cache**: Data được cache và tái sử dụng
- **Background refetching**: Tự động refetch khi cần
- **Optimistic updates**: Cập nhật UI trước khi API response
- **Error handling**: Xử lý lỗi một cách thống nhất
- **TypeScript support**: Hỗ trợ TypeScript tốt

### Các khái niệm chính:

#### Queries (useQuery)
- Dùng để **fetch data** từ server
- Tự động manage loading, error, success states
- Cache kết quả và tái sử dụng

```javascript
const { data, error, isLoading, refetch } = useGetPostsQuery()
```

#### Mutations (useMutation)
- Dùng để **thay đổi data** trên server (POST, PUT, DELETE)
- Có thể invalidate cache sau khi thành công

```javascript
const [createPost, { isLoading: isCreating }] = useCreatePostMutation()

const handleCreate = async () => {
  try {
    await createPost(newPostData).unwrap()
    // Thành công
  } catch (error) {
    // Xử lý lỗi
  }
}
```

#### Tags và Cache Invalidation
- **providesTags**: Đánh dấu data với tags
- **invalidatesTags**: Làm mất hiệu lực cache khi mutation thành công

```javascript
// Query provides tags
getPosts: builder.query({
  query: () => '/posts',
  providesTags: ['Post'],
}),

// Mutation invalidates tags
createPost: builder.mutation({
  query: (newPost) => ({
    url: '/posts',
    method: 'POST',
    body: newPost,
  }),
  invalidatesTags: ['Post'], // Sẽ refetch tất cả queries có tag 'Post'
})
```

## 3. Regular Redux Slice (appSlice.js)

Dùng cho state management cục bộ (không liên quan đến API):
- User authentication
- UI state (theme, modals)
- Shopping cart
- Form state

### Ưu điểm của createSlice:
- **Immer integration**: Có thể "mutate" state trực tiếp
- **Auto-generated actions**: Tự động tạo action creators
- **Less boilerplate**: Ít code hơn Redux truyền thống

```javascript
const appSlice = createSlice({
  name: 'app',
  initialState: {
    user: null,
    theme: 'light',
    cart: [],
  },
  reducers: {
    setUser: (state, action) => {
      state.user = action.payload // Immer cho phép "mutation" này
    },
    addToCart: (state, action) => {
      const item = action.payload
      const existingItem = state.cart.find(i => i.id === item.id)
      if (existingItem) {
        existingItem.quantity += 1
      } else {
        state.cart.push({ ...item, quantity: 1 })
      }
    },
  },
})
```

## 4. Sử dụng trong Components

### RTK Query Hooks
```javascript
import { useGetPostsQuery, useCreatePostMutation } from '../redux/apiSlice'

const PostsList = () => {
  // Tự động fetch data khi component mount
  const { data: posts, error, isLoading } = useGetPostsQuery()
  
  // Mutation hook
  const [createPost, { isLoading: isCreating }] = useCreatePostMutation()
  
  const handleCreate = async (postData) => {
    try {
      await createPost(postData).unwrap()
      alert('Success!')
    } catch (err) {
      alert('Error: ' + err.message)
    }
  }
  
  if (isLoading) return <div>Loading...</div>
  if (error) return <div>Error: {error.message}</div>
  
  return (
    <div>
      {posts?.map(post => (
        <div key={post.id}>{post.title}</div>
      ))}
    </div>
  )
}
```

### Regular Redux với useSelector và useDispatch
```javascript
import { useSelector, useDispatch } from 'react-redux'
import { addToCart, selectCart } from '../redux/appSlice'

const ShoppingCart = () => {
  const dispatch = useDispatch()
  const cart = useSelector(selectCart)
  
  const handleAddToCart = (product) => {
    dispatch(addToCart(product))
  }
  
  return (
    <div>
      Cart items: {cart.length}
      <button onClick={() => handleAddToCart(product)}>
        Add to Cart
      </button>
    </div>
  )
}
```

## 5. Best Practices

### Khi nào dùng RTK Query?
- Fetch data từ APIs
- Cần caching tự động
- Muốn quản lý loading/error states đơn giản
- Cần background refetching
- Làm việc với REST APIs hoặc GraphQL

### Khi nào dùng regular Redux slices?
- State cục bộ của app (user info, theme, UI state)
- Shopping cart, form data
- State không liên quan đến server
- Logic business phức tạp

### Cấu trúc dự án khuyến nghị:
```
src/
  redux/
    store.js              # Store configuration
    apiSlice.js           # RTK Query cho tất cả APIs
    slices/
      authSlice.js        # User authentication
      cartSlice.js        # Shopping cart
      uiSlice.js          # UI state (theme, modals)
    api/
      postsApi.js         # Specific API endpoints
      usersApi.js
```

### Performance Tips:
1. **Sử dụng tags thông minh** để invalidate cache chính xác
2. **Selective invalidation** thay vì invalidate toàn bộ
3. **Polling** cho real-time data khi cần
4. **Optimistic updates** cho UX tốt hơn
5. **Memoized selectors** với `createSelector`

## 6. Demo Routes

Truy cập các URLs sau để xem demo:
- `/rtk-demo` - RTK Query demo (fetch posts, users, CRUD operations)
- `/app-slice-demo` - Redux Slice demo (theme, auth, shopping cart)

## 7. Debugging

### Redux DevTools
Cài đặt Redux DevTools Extension để debug:
- Xem state changes theo thời gian
- Time travel debugging
- Action replay

### RTK Query DevTools
- Xem cache status
- Monitor API calls
- Cache invalidation tracking

## Kết luận

Redux Toolkit và RTK Query giúp:
- **Giảm boilerplate code** đáng kể
- **Tăng performance** nhờ caching thông minh
- **Đơn giản hóa** việc quản lý async operations
- **Cải thiện developer experience** với DevTools tốt
- **Type safety** tốt hơn với TypeScript